<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Puter.js + Claude Chat (with Fallback)</title>

    <!-- Puter.js -->
    <script src="https://js.puter.com/v2/"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 800px;
            margin: 24px auto;
            padding: 0 16px 40px;
            background: #0f172a;
            color: #e5e7eb;
        }
        h1 { font-size: 1.6rem; margin-bottom: 0.4rem; }
        .subtitle { font-size: 0.9rem; color: #9ca3af; margin-bottom: 1.2rem; }
        label { font-size: 0.85rem; color: #9ca3af; display: block; margin-bottom: 4px; }
        textarea, input, select {
            width: 100%;
            box-sizing: border-box;
            background: #020617;
            color: #e5e7eb;
            border: 1px solid #1e293b;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 0.9rem;
            resize: vertical;
        }
        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: #38bdf8;
        }
        .row { display: flex; gap: 10px; margin-top: 10px; }
        .row > div { flex: 1; }
        button {
            margin-top: 10px;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background: #38bdf8;
            color: #020617;
            font-weight: 600;
            font-size: 0.9rem;
        }
        button:disabled { opacity: 0.6; cursor: default; }
        #status { font-size: 0.8rem; color: #9ca3af; margin-top: 6px; }
        #output {
            margin-top: 16px;
            padding: 12px 14px;
            border-radius: 8px;
            background: #020617;
            border: 1px solid #1e293b;
            min-height: 80px;
            line-height: 1.5;
            font-size: 0.9rem;
            white-space: normal;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>Puter.js + Claude Chat</h1>
    <div class="subtitle">
        System prompt + streaming + sab Anthropic Claude models (with usage‑limit fallback).
    </div>

    <form id="chat-form">
        <label for="system">System prompt (AI ka behaviour)</label>
        <textarea id="system" rows="4">
You are Claude (Anthropic).
Explain clearly. If the user speaks Hindi, reply in Hindi.
Use short paragraphs and avoid hallucinations.
        </textarea>

        <label for="user">User prompt (aapka sawaal)</label>
        <textarea id="user" rows="3">hii</textarea>

        <div class="row">
            <div>
                <label for="model">Anthropic model select karo</label>
                <select id="model">
                    <option value="claude-sonnet-4" selected>claude-sonnet-4</option>
                    <option value="claude-sonnet-4-5">claude-sonnet-4-5</option>
                    <option value="claude-opus-4">claude-opus-4</option>
                    <option value="claude-opus-4-1">claude-opus-4-1</option>
                    <option value="claude-haiku-4-5">claude-haiku-4-5</option>
                </select>
            </div>
            <div>
                <label for="temperature">Temperature (0–2, creativity)</label>
                <input id="temperature" type="number" step="0.1" min="0" max="2" value="0.7" />
            </div>
        </div>

        <button id="run-btn" type="submit">Send</button>
        <div id="status"></div>
    </form>

    <div id="output"></div>

    <script>
        (async () => {
            if (typeof puter.init === "function") {
                try {
                    await puter.init();
                } catch (e) {
                    console.warn("Puter init failed (continuing anyway):", e);
                }
            }

            const form     = document.getElementById('chat-form');
            const systemEl = document.getElementById('system');
            const userEl   = document.getElementById('user');
            const modelEl  = document.getElementById('model');
            const tempEl   = document.getElementById('temperature');
            const runBtn   = document.getElementById('run-btn');
            const statusEl = document.getElementById('status');
            const outputEl = document.getElementById('output');

            async function callPuter(messages, model) {
                const temperature = Number(tempEl.value) || 0.7;

                // Puter docs style: chat(messages, testMode, options)
                return await puter.ai.chat(
                    messages,
                    false,
                    {
                        model,
                        stream: true,
                        temperature,
                        max_tokens: 800
                    }
                );
            }

            function parseDelegate(err) {
                let obj = null;

                if (err && typeof err === "object") {
                    obj = err;
                } else if (typeof err === "string") {
                    try { obj = JSON.parse(err); } catch (e) { obj = null; }
                }

                const delegate =
                    obj?.error?.delegate ||
                    obj?.delegate ||
                    null;

                return { obj, delegate };
            }

            async function runChat(userText, systemText) {
                outputEl.innerHTML = '';
                statusEl.textContent = 'Thinking with ' + modelEl.value + '… (streaming)';
                runBtn.disabled = true;

                const messages = [
                    { role: "system", content: systemText.trim() },
                    { role: "user",   content: userText.trim() }
                ];

                const selectedModel = modelEl.value;

                try {
                    // 1) Try selected Claude model
                    let streamResp = await callPuter(messages, selectedModel);

                    let fullText = '';
                    for await (const part of streamResp) {
                        if (part?.text) {
                            fullText += part.text;
                            outputEl.innerHTML = fullText.replaceAll('\n', '<br>');
                        }
                    }

                    statusEl.textContent = 'Done ✔ (' + selectedModel + ')';
                } catch (err) {
                    console.error('Full error from puter.ai.chat (Claude):', err);
                    const { obj, delegate } = parseDelegate(err);

                    // usage limit triggered for Claude
                    if (delegate === 'usage-limited-chat') {
                        statusEl.textContent =
                            'Claude free limit hit (usage-limited-chat). Trying GPT-5 nano fallback…';

                        try {
                            // 2) Fallback to a cheap OpenAI model via Puter (example: gpt-5-nano)
                            const fallbackModel = 'gpt-5-nano'; // Puter examples ka default model
                            let streamResp2 = await callPuter(messages, fallbackModel);

                            let fullText2 = '';
                            for await (const part of streamResp2) {
                                if (part?.text) {
                                    fullText2 += part.text;
                                    outputEl.innerHTML = fullText2.replaceAll('\n', '<br>');
                                }
                            }

                            statusEl.textContent = 'Done ✔ (fallback: ' + fallbackModel + ')';
                        } catch (err2) {
                            console.error('Fallback model error:', err2);
                            statusEl.textContent =
                                'Claude limit + fallback model error. Please try later or change network.';
                            const msg2 =
                                (err2 && err2.message) ||
                                (typeof err2 === 'object' ? JSON.stringify(err2) : String(err2));
                            outputEl.innerHTML =
                                '<span style="color:#f97373;">Error: ' + msg2 + '</span>';
                        }
                    } else {
                        statusEl.textContent = 'Error while calling Claude. Check console (F12).';
                        const msg =
                            (err && err.message) ||
                            (typeof err === 'object' ? JSON.stringify(err) : String(err));
                        outputEl.innerHTML =
                            '<span style="color:#f97373;">Error: ' + msg + '</span>';
                    }
                } finally {
                    runBtn.disabled = false;
                }
            }

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const userText   = userEl.value.trim();
                const systemText = systemEl.value.trim();

                if (!userText) {
                    statusEl.textContent = 'Please enter a user prompt.';
                    return;
                }

                runChat(userText, systemText);
            });

            // First auto run
            runChat(userEl.value, systemEl.value);
        })();
    </script>
</body>
</html>

